name: Sync Markdown to Outline Wiki

on:
  push:
    paths:
      - 'README.md'        # ‚úÖ triggers only when README.md changes
      # - 'docs/*.mdx'     # (optional) add more file paths here
  workflow_dispatch:        # ‚úÖ Allow manual trigger from GitHub Actions UI
    inputs:
      file:
        description: 'Markdown file to sync to Outline'
        required: false
        default: 'README.md'

env:
  MARKDOWN_FILE: 'README.md'                        # ‚úÖ configurable at the top
  OUTLINE_API_URL: ${{ secrets.OUTLINE_API_URL }}   # e.g. https://your-outline.com/api
  OUTLINE_API_TOKEN: ${{ secrets.OUTLINE_API_TOKEN }}
  OUTLINE_COLLECTION_ID: ${{ secrets.OUTLINE_COLLECTION_ID }}
  OUTLINE_DOCUMENT_ID: ${{ secrets.OUTLINE_DOCUMENT_ID }}   # optional if updating existing doc

jobs:
  sync-outline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Markdown file
        run: |
          if [ ! -f "$MARKDOWN_FILE" ]; then
            echo "‚ùå File '$MARKDOWN_FILE' not found!"
            exit 1
          fi
          echo "‚úÖ Found file: $MARKDOWN_FILE"

      - name: Upload to Outline (create or update)
        id: upload
        run: |
          set -e

          CONTENT=$(cat "$MARKDOWN_FILE")
          TITLE=$(basename "$MARKDOWN_FILE" | sed 's/\.[^.]*$//')

          CONTENT_JSON=$(printf '%s' "$CONTENT" | jq -Rs .)

          JSON_PAYLOAD=$(jq -n \
            --arg title "$TITLE" \
            --arg text "$CONTENT" \
            --arg collectionId "$OUTLINE_COLLECTION_ID" \
            '{
              title: $title,
              text: $text,
              collectionId: $collectionId
            }')

          echo "üöÄ Syncing '$MARKDOWN_FILE' to Outline as '$TITLE'..."

          if [ -n "$OUTLINE_DOCUMENT_ID" ]; then
            echo "üìù Updating existing document ($OUTLINE_DOCUMENT_ID)"
            ENDPOINT="$OUTLINE_API_URL/documents.update"
          else
            echo "üÜï Creating new document"
            ENDPOINT="$OUTLINE_API_URL/documents.create"
          fi

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "$ENDPOINT" \
            -H "Authorization: Bearer $OUTLINE_API_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD")

          BODY=$(echo "$RESPONSE" | head -n 1)
          STATUS=$(echo "$RESPONSE" | tail -n 1)

          echo "üì° HTTP Status: $STATUS"

          if [ "$STATUS" -ge 200 ] && [ "$STATUS" -lt 300 ]; then
            echo "‚úÖ Outline sync successful."
            DOC_ID=$(echo "$BODY" | jq -r '.data.id // empty')
            if [ -n "$DOC_ID" ]; then
              echo "üÜî Document ID: $DOC_ID"
              echo "doc_id=$DOC_ID" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "‚ùå API call failed (HTTP $STATUS)"
            echo "Response:"
            echo "$BODY" | jq || echo "$BODY"
            exit 1
          fi

      - name: Mark document read-only
        if: success()
        run: |
          set -e
          DOC_ID="${{ steps.upload.outputs.doc_id || env.OUTLINE_DOCUMENT_ID }}"
          if [ -z "$DOC_ID" ]; then
            echo "‚ÑπÔ∏è No document ID found ‚Äî skipping read-only step."
            exit 0
          fi

          echo "üîí Setting document '$DOC_ID' to read-only..."

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "$OUTLINE_API_URL/documents.permissions.update" \
            -H "Authorization: Bearer $OUTLINE_API_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"id\":\"$DOC_ID\",\"permission\":\"read\"}")

          BODY=$(echo "$RESPONSE" | head -n 1)
          STATUS=$(echo "$RESPONSE" | tail -n 1)

          echo "üì° HTTP Status: $STATUS"

          if [ "$STATUS" -ge 200 ] && [ "$STATUS" -lt 300 ]; then
            echo "‚úÖ Document marked read-only."
          else
            echo "‚ùå Failed to update permissions (HTTP $STATUS)"
            echo "$BODY" | jq || echo "$BODY"
            exit 1
          fi
