name: Sync README to Outline

on:
  push:
    paths:
      - "README.md"   # Trigger only when README.md changes
  workflow_dispatch:   # Allow manual trigger

jobs:
  sync-outline:
    runs-on: ubuntu-latest

    env:
      OUTLINE_API_URL: "https://app.getoutline.com/api"
      OUTLINE_API_TOKEN: ${{ secrets.OUTLINE_API_TOKEN }}
      OUTLINE_COLLECTION_ID: "07467d87-b32c-4bfa-9535-b6d112ffb7e0"
      OUTLINE_DOCUMENT_ID: "26cc4d5c-edca-4e37-b727-69afc049d9b3"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Sync README.md to Outline
        run: |
          set -e

          FILE_PATH="README.md"
          TITLE=$(basename "$FILE_PATH" .md)
          CONTENT=$(cat "$FILE_PATH" | jq -Rs .)

          echo "üöÄ Syncing '$FILE_PATH' to Outline as '$TITLE'..."
          echo "üìù Updating existing document ($OUTLINE_DOCUMENT_ID)"

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer $OUTLINE_API_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg id "$OUTLINE_DOCUMENT_ID" \
              --arg title "$TITLE" \
              --argjson text "$CONTENT" \
              '{id: $id, title: $title, text: $text, publish: true}')" \
            "$OUTLINE_API_URL/documents.update")

          BODY=$(echo "$RESPONSE" | head -n -1)
          STATUS=$(echo "$RESPONSE" | tail -n 1)

          echo "üì° HTTP Status: $STATUS"
          echo "$BODY" | jq .

          if [ "$STATUS" -ne 200 ]; then
            echo "‚ùå API call failed (HTTP $STATUS)"
            exit 1
          fi

          echo "‚úÖ Successfully updated '$TITLE' in Outline!"
