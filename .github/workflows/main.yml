name: Sync Markdown to Outline Wiki

on:
  push:
    paths:
      - 'README.md'        # ‚úÖ Trigger only when this file changes
      # - 'docs/guide.mdx' # (optional) you can add more files here

env:
  MARKDOWN_FILE: 'README.md'                        # ‚úÖ configurable at the top
  OUTLINE_API_URL: ${{ secrets.OUTLINE_API_URL }}   # e.g. https://your-outline.com/api
  OUTLINE_API_TOKEN: ${{ secrets.OUTLINE_API_TOKEN }}
  OUTLINE_COLLECTION_ID: ${{ secrets.OUTLINE_COLLECTION_ID }}
  OUTLINE_DOCUMENT_ID: ${{ secrets.OUTLINE_DOCUMENT_ID }}   # optional if updating existing doc

jobs:
  sync-outline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate file exists
        run: |
          if [ ! -f "$MARKDOWN_FILE" ]; then
            echo "‚ùå File $MARKDOWN_FILE not found!"
            exit 1
          fi
          echo "‚úÖ Found file: $MARKDOWN_FILE"

      - name: Upload to Outline
        run: |
          CONTENT=$(cat "$MARKDOWN_FILE")
          CONTENT_JSON=$(printf '%s' "$CONTENT" | jq -Rs .)
          TITLE=$(basename "$MARKDOWN_FILE" | sed 's/\.[^.]*$//')

          # Build request payload
          JSON_PAYLOAD=$(jq -n \
            --arg title "$TITLE" \
            --arg text "$CONTENT" \
            --arg collectionId "$OUTLINE_COLLECTION_ID" \
            '{
              title: $title,
              text: $text,
              collectionId: $collectionId
            }')

          if [ -n "$OUTLINE_DOCUMENT_ID" ]; then
            echo "üìù Updating existing Outline document..."
            curl -s -o response.json -w "%{http_code}" \
              -X PATCH "$OUTLINE_API_URL/documents/$OUTLINE_DOCUMENT_ID" \
              -H "Authorization: Bearer $OUTLINE_API_TOKEN" \
              -H "Content-Type: application/json" \
              -d "$JSON_PAYLOAD"
          else
            echo "üÜï Creating new Outline document..."
            curl -s -o response.json -w "%{http_code}" \
              -X POST "$OUTLINE_API_URL/documents.create" \
              -H "Authorization: Bearer $OUTLINE_API_TOKEN" \
              -H "Content-Type: application/json" \
              -d "$JSON_PAYLOAD"
          fi

      - name: Mark document read-only
        if: success()
        run: |
          if [ -z "$OUTLINE_DOCUMENT_ID" ]; then
            echo "‚ÑπÔ∏è Skipping read-only step (no document ID)"
            exit 0
          fi
          echo "üîí Setting document to read-only..."
          # Adjust this endpoint if your Outline supports permission editing
          curl -s -X POST "$OUTLINE_API_URL/documents.permissions.update" \
            -H "Authorization: Bearer $OUTLINE_API_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"id\":\"$OUTLINE_DOCUMENT_ID\",\"permission\":\"read\"}"
